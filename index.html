<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<!-- Viewport ottimizzato per mobile: impedisce lo zoom accidentale e gestisce la safe area -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Tesla Trip Monitor v5</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    /* Dark Theme (Default) */
    --bg: #0a0a0f;
    --surface: #12121a;
    --surface2: #1a1a26;
    --surface3: #222233;
    --border: #2a2a3d;
    --text: #e8e8f0;
    --text-dim: #8888a8;
    --accent: #e74040;
    --accent-glow: rgba(231, 64, 64, 0.25);
    --tesla-blue: #3e8bff;
    --tesla-blue-glow: rgba(62, 139, 255, 0.2);
    --green: #34d399;
    --green-glow: rgba(52, 211, 153, 0.15);
    --amber: #fbbf24;
    --radius: 16px; /* Arrotondamento pi√π morbido stile OneUI */
    --radius-sm: 10px;
    --shadow: 0 4px 20px rgba(0,0,0,0.2);
  }

  /* Light Theme Variables */
  body.light-mode {
    --bg: #f2f2f7;
    --surface: #ffffff;
    --surface2: #f2f2f7;
    --surface3: #e5e5ea;
    --border: #d1d1d6;
    --text: #1c1c1e;
    --text-dim: #8e8e93;
    --accent: #ff3b30;
    --accent-glow: rgba(255, 59, 48, 0.15);
    --tesla-blue: #007aff;
    --tesla-blue-glow: rgba(0, 122, 255, 0.15);
    --green: #34c759;
    --green-glow: rgba(52, 199, 89, 0.15);
    --amber: #ff9500;
    --shadow: 0 2px 10px rgba(0,0,0,0.05);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
    transition: background 0.3s ease, color 0.3s ease;
  }

  /* Ambient background */
  body::before {
    content: '';
    position: fixed;
    top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(ellipse at 30% 20%, var(--tesla-blue-glow) 0%, transparent 40%),
                radial-gradient(ellipse at 70% 80%, var(--accent-glow) 0%, transparent 40%);
    pointer-events: none;
    z-index: 0;
    opacity: 0.6;
    transition: opacity 0.3s;
  }
  body.light-mode::before { opacity: 0.3; }

  .app { 
    position: relative; 
    z-index: 1; 
    max-width: 600px; 
    margin: 0 auto; 
    padding: 16px; 
    padding-bottom: 120px; /* Spazio extra per lo scroll su mobile */
    padding-top: env(safe-area-inset-top); /* Gestione notch */
  }

  /* Header */
  .header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 0 24px;
  }
  .header-content { text-align: left; }
  .header-logo {
    font-size: 11px; font-weight: 700; letter-spacing: 1px;
    text-transform: uppercase; color: var(--tesla-blue); margin-bottom: 2px;
  }
  .header h1 {
    font-size: 26px; font-weight: 800; letter-spacing: -0.5px;
    color: var(--text);
  }
  
  /* Theme Toggle Button */
  .theme-toggle {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    width: 40px; height: 40px;
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.2s;
  }
  .theme-toggle:active { transform: scale(0.95); }

  /* Navigation tabs */
  .nav-tabs {
    display: flex; gap: 6px;
    background: var(--surface);
    border-radius: 14px;
    padding: 5px;
    margin-bottom: 20px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
  }
  .nav-tab {
    flex: 1; padding: 12px;
    border: none; background: transparent;
    color: var(--text-dim);
    font-family: 'Outfit', sans-serif; font-size: 14px; font-weight: 600;
    border-radius: 10px; cursor: pointer; transition: all 0.3s;
  }
  .nav-tab.active {
    background: var(--surface3); color: var(--text);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 16px;
    box-shadow: var(--shadow);
    transition: transform 0.2s;
  }
  .card:active { transform: scale(0.995); }

  .card-title {
    font-size: 12px; font-weight: 700; letter-spacing: 1px;
    text-transform: uppercase; color: var(--text-dim);
    margin-bottom: 16px; display: flex; align-items: center; gap: 8px;
  }
  .card-title .dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--accent); box-shadow: 0 0 8px var(--accent-glow);
  }

  /* Inputs - Mobile Optimized Height */
  .input-group { margin-bottom: 16px; position: relative; }
  .input-group label {
    display: block; font-size: 13px; font-weight: 600;
    color: var(--text-dim); margin-bottom: 8px;
  }
  .input-group input, .input-group select {
    width: 100%; padding: 14px 16px; /* Pi√π alto per il tocco */
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace; font-size: 16px; /* Font 16px evita zoom su iOS */
    outline: none; transition: border-color 0.3s;
    appearance: none; /* Rimuove stile nativo iOS/Android */
  }
  .input-group input:focus { border-color: var(--tesla-blue); }
  
  .input-hint {
    font-size: 11px; color: var(--tesla-blue);
    margin-top: 6px; font-family: 'JetBrains Mono', monospace;
    display: block; text-align: right;
  }

  .input-row { display: flex; gap: 12px; }
  .input-row .input-group { flex: 1; }

  /* Buttons - Mobile Optimized */
  .btn {
    width: 100%; padding: 16px; /* Area di tocco pi√π grande */
    border: none; border-radius: 12px;
    font-family: 'Outfit', sans-serif; font-size: 15px; font-weight: 700;
    cursor: pointer; transition: transform 0.1s;
    display: flex; justify-content: center; align-items: center; gap: 8px;
  }
  .btn:active { transform: scale(0.97); }
  
  .btn-primary { background: var(--accent); color: #fff; box-shadow: 0 4px 15px var(--accent-glow); }
  .btn-blue { background: var(--tesla-blue); color: #fff; box-shadow: 0 4px 15px var(--tesla-blue-glow); }
  .btn-green { background: var(--green); color: #fff; box-shadow: 0 4px 15px var(--green-glow); }
  .btn-outline { background: transparent; color: var(--text); border: 2px solid var(--border); }
  .btn-danger { background: transparent; color: var(--accent); border: 2px solid rgba(231,64,64,0.3); }
  
  .btn-sm { width: auto; padding: 10px 18px; font-size: 13px; }
  .btn-xs { width: 36px; height: 36px; padding: 0; border-radius: 8px; font-size: 16px; }

  /* Stats grid */
  .stats-grid {
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;
  }
  .stat-box {
    background: var(--surface2); border-radius: var(--radius-sm);
    padding: 16px; text-align: center;
  }
  .stat-value {
    font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 700;
    color: var(--text); line-height: 1.1; margin-bottom: 4px;
  }
  .stat-value.blue { color: var(--tesla-blue); }
  .stat-value.green { color: var(--green); }
  .stat-value.amber { color: var(--amber); }
  .stat-value.red { color: var(--accent); }
  .stat-label {
    font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
    text-transform: uppercase; color: var(--text-dim);
  }

  /* Charge log */
  .charge-entry {
    background: var(--surface2); border-radius: var(--radius-sm);
    padding: 16px; margin-bottom: 10px;
    border-left: 4px solid var(--tesla-blue);
  }
  .charge-entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
  .charge-entry-name { font-weight: 700; font-size: 15px; }
  .charge-entry-num {
    font-family: 'JetBrains Mono', monospace; font-size: 11px;
    color: var(--text-dim); background: var(--surface);
    padding: 4px 8px; border-radius: 6px;
  }
  .charge-entry-details {
    display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; font-size: 13px;
  }
  .soc-badge {
    background: var(--surface3); border: 1px solid var(--border);
    border-radius: 6px; padding: 4px 8px;
    font-family: 'JetBrains Mono', monospace; font-size: 12px;
    color: var(--green); display: inline-block; margin-top: 6px; font-weight: 600;
  }

  /* Comparison bar */
  .comparison-bar { margin-top: 12px; }
  .bar-container {
    height: 36px; background: var(--surface2); border-radius: 8px;
    overflow: hidden; position: relative; margin-bottom: 8px;
  }
  .bar-fill {
    height: 100%; border-radius: 8px; display: flex; align-items: center;
    padding-left: 12px; font-family: 'JetBrains Mono', monospace;
    font-size: 13px; font-weight: 700; color: #fff;
  }
  .bar-label { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-dim); margin-bottom: 2px; }

  /* Map */
  #map { width: 100%; height: 320px; border-radius: var(--radius); border: 1px solid var(--border); margin-top: 12px; }

  /* Trip list */
  .trip-item {
    background: var(--surface2); border-radius: var(--radius-sm);
    padding: 16px; margin-bottom: 10px; cursor: pointer;
    border: 1px solid transparent; position: relative;
    padding-right: 40px; /* Space for arrow */
  }
  .trip-item::after {
    content: '‚Ä∫'; position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
    font-size: 24px; color: var(--border); font-weight: 300;
  }
  .trip-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
  .trip-item-name { font-weight: 700; font-size: 16px; }
  .trip-item-date { font-size: 12px; color: var(--text-dim); }
  .trip-item-stats { display: flex; gap: 16px; font-size: 13px; color: var(--text-dim); }
  .trip-item-stats span { font-family: 'JetBrains Mono', monospace; color: var(--text); font-weight: 600; }

  /* Sections */
  .section { display: none; padding-bottom: 40px; }
  .section.active { display: block; animation: slideIn 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); }
  @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

  /* Bottom Sheet Modal */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
    z-index: 100; justify-content: center; align-items: flex-end; /* Bottom alignment */
  }
  .modal-overlay.show { display: flex; }
  .modal {
    background: var(--surface);
    border-top: 1px solid var(--border);
    border-radius: 24px 24px 0 0; /* Rounded top only */
    padding: 24px; padding-bottom: calc(30px + env(safe-area-inset-bottom));
    width: 100%; max-width: 600px;
    max-height: 90vh; overflow-y: auto;
    animation: slideUp 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    box-shadow: 0 -4px 30px rgba(0,0,0,0.3);
  }
  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  
  .modal h3 { font-size: 20px; font-weight: 800; margin-bottom: 20px; }

  .divider { height: 1px; background: var(--border); margin: 20px 0; }
  .badge {
    padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700;
    font-family: 'JetBrains Mono', monospace; letter-spacing: 0.5px;
  }
  .badge-green { background: var(--green-glow); color: var(--green); border: 1px solid rgba(52,211,153,0.3); }

  .empty-state { text-align: center; padding: 60px 20px; color: var(--text-dim); }
  .empty-state .icon { font-size: 56px; margin-bottom: 16px; opacity: 0.5; }
  
  .actions-row { display: flex; gap: 10px; margin-top: 10px; }
  .actions-row .btn { flex: 1; }

  /* Scrollbar hide */
  ::-webkit-scrollbar { display: none; }
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <div class="header-content">
      <div class="header-logo">‚ö° TESLA</div>
      <h1>Trip Monitor</h1>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">üåô</button>
  </div>

  <div class="nav-tabs">
    <button class="nav-tab active" onclick="showSection('trips')">Viaggi</button>
    <button class="nav-tab" onclick="showSection('active')">In Corso</button>
    <button class="nav-tab" onclick="showSection('map')">Mappa</button>
  </div>

  <!-- TRIPS LIST SECTION -->
  <div id="section-trips" class="section active">
    <button class="btn btn-primary" onclick="openNewTripModal()" style="margin-bottom:20px">+ Nuovo Viaggio</button>
    <div id="trips-list"></div>
  </div>

  <!-- ACTIVE TRIP SECTION -->
  <div id="section-active" class="section">
    <div id="no-active-trip" class="empty-state">
      <div class="icon">üõ£Ô∏è</div>
      <p>Nessun viaggio attivo.<br>Inizia un nuovo viaggio dalla sezione Viaggi.</p>
    </div>
    <div id="active-trip-content" style="display:none">
      <div class="card">
        <div class="card-title"><span class="dot"></span> <span id="active-trip-name">‚Äî</span></div>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value blue" id="stat-km">0</div>
            <div class="stat-label">km</div>
          </div>
          <div class="stat-box">
            <div class="stat-value amber" id="stat-kwh">0</div>
            <div class="stat-label">kWh</div>
          </div>
          <div class="stat-box">
            <div class="stat-value green" id="stat-efficiency">0</div>
            <div class="stat-label">Wh/km</div>
          </div>
          <div class="stat-box">
            <div class="stat-value red" id="stat-cost">0</div>
            <div class="stat-label">‚Ç¨ Tot</div>
          </div>
        </div>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value" id="stat-charges">0</div>
            <div class="stat-label">Cariche</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="stat-kwh-charged">0</div>
            <div class="stat-label">+kWh</div>
          </div>
        </div>
        <div class="actions-row">
          <button class="btn btn-blue" onclick="openChargeModal()">‚ö° Ricarica</button>
        </div>
        <div class="actions-row">
          <button class="btn btn-green" onclick="openEndTripModal()">üèÅ Fine</button>
        </div>
      </div>

      <!-- Diesel comparison -->
      <div class="card" id="diesel-comparison-card">
        <div class="card-title"><span class="dot" style="background:var(--amber)"></span> Confronto Diesel</div>
        <div id="diesel-comparison-content"></div>
      </div>

      <!-- Charge log -->
      <div class="card">
        <div class="card-title"><span class="dot" style="background:var(--tesla-blue)"></span> Log Ricariche</div>
        <div id="charge-log"></div>
      </div>

      <!-- Trip Map -->
      <div class="card">
        <div class="card-title"><span class="dot" style="background:var(--green)"></span> Mappa Ricariche</div>
        <div id="trip-map" style="width:100%;height:300px;border-radius:var(--radius-sm);"></div>
      </div>
    </div>
  </div>

  <!-- MAP SECTION (all charges, all trips) -->
  <div id="section-map" class="section">
    <div class="card">
      <div class="card-title"><span class="dot" style="background:var(--green)"></span> Storico Ricariche</div>
      <p style="font-size:13px;color:var(--text-dim);margin-bottom:10px;">Tutte le ricariche di tutti i viaggi</p>
      <div id="map"></div>
    </div>
  </div>
</div>

<!-- NEW TRIP MODAL -->
<div class="modal-overlay" id="modal-new-trip">
  <div class="modal">
    <h3>üöó Nuovo Viaggio</h3>
    <div class="input-group">
      <label>Nome del viaggio</label>
      <input type="text" id="trip-name" placeholder="Es: Vacanze 2026">
    </div>
    <div class="input-row">
      <div class="input-group">
        <label>Km ODO</label>
        <input type="number" id="trip-start-km" placeholder="25000" inputmode="decimal">
      </div>
      <div class="input-group">
        <label>kWh Tot</label>
        <input type="number" id="trip-start-kwh" placeholder="4500" step="0.1" inputmode="decimal">
      </div>
    </div>
    <div class="input-group">
      <label>SoC Partenza %</label>
      <input type="number" id="trip-start-soc" placeholder="100" min="0" max="100" inputmode="decimal">
    </div>
    <div class="divider"></div>
    <p style="font-size:12px;color:var(--text-dim);margin-bottom:12px;">Confronto Diesel</p>
    <div class="input-row">
      <div class="input-group">
        <label>‚Ç¨/litro</label>
        <input type="number" id="diesel-price" placeholder="1.75" step="0.01" value="1.75" inputmode="decimal">
      </div>
      <div class="input-group">
        <label>Km/litro</label>
        <input type="number" id="diesel-consumption" placeholder="15" step="0.1" value="15" inputmode="decimal">
      </div>
    </div>
    <div class="actions-row" style="margin-top:20px">
      <button class="btn btn-outline" onclick="closeModal('modal-new-trip')">Annulla</button>
      <button class="btn btn-primary" onclick="createTrip()">Inizia</button>
    </div>
  </div>
</div>

<!-- CHARGE MODAL -->
<div class="modal-overlay" id="modal-charge">
  <div class="modal">
    <h3>‚ö° Nuova Ricarica</h3>
    <div class="input-group">
      <label>Nome / Luogo</label>
      <input type="text" id="charge-name" placeholder="Es: Supercharger">
    </div>
    <div class="input-row">
      <div class="input-group">
        <label>Km attuali</label>
        <input type="number" id="charge-km" inputmode="decimal">
        <small class="input-hint" id="last-km-hint"></small>
      </div>
      <div class="input-group">
        <label>kWh attuali</label>
        <input type="number" id="charge-kwh-consumed" step="0.1" inputmode="decimal">
        <small class="input-hint" id="last-kwh-hint"></small>
      </div>
    </div>
    
    <!-- SoC Section -->
    <div class="input-row" style="background:var(--surface2); padding:10px; border-radius:12px; margin-bottom:16px; border:1px solid var(--border)">
      <div class="input-group" style="margin-bottom:0">
        <label>SoC Arrivo %</label>
        <input type="number" id="charge-soc-arr" placeholder="10" min="0" max="100" style="background:var(--surface)" inputmode="decimal">
      </div>
      <div style="display:flex;align-items:center;color:var(--text-dim);font-size:20px">‚ûî</div>
      <div class="input-group" style="margin-bottom:0">
        <label>SoC Partenza %</label>
        <input type="number" id="charge-soc-dep" placeholder="80" min="0" max="100" style="background:var(--surface)" inputmode="decimal">
      </div>
    </div>

    <div class="input-row">
      <div class="input-group">
        <label>Costo ‚Ç¨/kWh</label>
        <input type="number" id="charge-cost-kwh" placeholder="0.45" step="0.01" inputmode="decimal">
      </div>
      <div class="input-group">
        <label>kWh caricati</label>
        <input type="number" id="charge-kwh-added" placeholder="35" step="0.1" inputmode="decimal">
      </div>
    </div>
    <div class="gps-status" id="gps-status">
      <div class="gps-dot"></div> GPS in corso...
    </div>
    <div class="actions-row" style="margin-top:20px">
      <button class="btn btn-outline" onclick="closeModal('modal-charge')">Annulla</button>
      <button class="btn btn-blue" onclick="saveCharge()">Salva</button>
    </div>
  </div>
</div>

<!-- EDIT CHARGE MODAL -->
<div class="modal-overlay" id="modal-edit-charge">
  <div class="modal">
    <h3>‚úèÔ∏è Modifica Ricarica</h3>
    <input type="hidden" id="edit-charge-trip-id">
    <input type="hidden" id="edit-charge-index">
    
    <div class="input-group">
      <label>Nome / Luogo</label>
      <input type="text" id="edit-charge-name">
    </div>
    <div class="input-row">
      <div class="input-group">
        <label>Km attuali</label>
        <input type="number" id="edit-charge-km" inputmode="decimal">
      </div>
      <div class="input-group">
        <label>kWh attuali</label>
        <input type="number" id="edit-charge-kwh-consumed" step="0.1" inputmode="decimal">
      </div>
    </div>
    <div class="input-row" style="background:var(--surface2); padding:10px; border-radius:12px; margin-bottom:16px; border:1px solid var(--border)">
      <div class="input-group" style="margin-bottom:0">
        <label>SoC Arrivo %</label>
        <input type="number" id="edit-charge-soc-arr" min="0" max="100" style="background:var(--surface)" inputmode="decimal">
      </div>
      <div style="display:flex;align-items:center;color:var(--text-dim);font-size:20px">‚ûî</div>
      <div class="input-group" style="margin-bottom:0">
        <label>SoC Partenza %</label>
        <input type="number" id="edit-charge-soc-dep" min="0" max="100" style="background:var(--surface)" inputmode="decimal">
      </div>
    </div>
    <div class="input-row">
      <div class="input-group">
        <label>Costo ‚Ç¨/kWh</label>
        <input type="number" id="edit-charge-cost-kwh" step="0.01" inputmode="decimal">
      </div>
      <div class="input-group">
        <label>kWh caricati</label>
        <input type="number" id="edit-charge-kwh-added" step="0.1" inputmode="decimal">
      </div>
    </div>
    
    <div class="actions-row" style="margin-top:20px; padding-top:15px; border-top:1px solid var(--border)">
      <button class="btn btn-danger" onclick="deleteCharge()">Elimina</button>
      <button class="btn btn-outline" onclick="closeModal('modal-edit-charge')">Annulla</button>
      <button class="btn btn-primary" onclick="saveEditedCharge()">Salva</button>
    </div>
  </div>
</div>

<!-- EDIT TRIP MODAL -->
<div class="modal-overlay" id="modal-edit-trip">
  <div class="modal">
    <h3>‚úèÔ∏è Modifica Viaggio</h3>
    <input type="hidden" id="edit-trip-id">
    <div class="input-group">
      <label>Nome</label>
      <input type="text" id="edit-trip-name">
    </div>
    <div class="input-row">
      <div class="input-group">
        <label>Km Start</label>
        <input type="number" id="edit-trip-start-km" inputmode="decimal">
      </div>
      <div class="input-group">
        <label>kWh Start</label>
        <input type="number" id="edit-trip-start-kwh" step="0.1" inputmode="decimal">
      </div>
    </div>
    <div class="input-group">
      <label>SoC Start %</label>
      <input type="number" id="edit-trip-start-soc" min="0" max="100" inputmode="decimal">
    </div>
    <div class="divider"></div>
    <div class="input-row">
      <div class="input-group">
        <label>Diesel ‚Ç¨/l</label>
        <input type="number" id="edit-diesel-price" step="0.01" inputmode="decimal">
      </div>
      <div class="input-group">
        <label>Diesel Km/l</label>
        <input type="number" id="edit-diesel-consumption" step="0.1" inputmode="decimal">
      </div>
    </div>
    <div class="actions-row" style="margin-top:20px">
      <button class="btn btn-outline" onclick="closeModal('modal-edit-trip')">Annulla</button>
      <button class="btn btn-primary" onclick="saveEditedTrip()">Salva</button>
    </div>
  </div>
</div>

<!-- END TRIP MODAL -->
<div class="modal-overlay" id="modal-end-trip">
  <div class="modal">
    <h3>üèÅ Fine Viaggio</h3>
    <div class="input-row">
      <div class="input-group">
        <label>Km Finali</label>
        <input type="number" id="end-km" placeholder="25800" inputmode="decimal">
      </div>
      <div class="input-group">
        <label>kWh Finali</label>
        <input type="number" id="end-kwh" placeholder="4650" step="0.1" inputmode="decimal">
      </div>
    </div>
    <div class="input-group">
      <label>SoC Finale %</label>
      <input type="number" id="end-soc" placeholder="20" min="0" max="100" inputmode="decimal">
    </div>
    <div class="actions-row" style="margin-top:20px">
      <button class="btn btn-outline" onclick="closeModal('modal-end-trip')">Annulla</button>
      <button class="btn btn-green" onclick="endTrip()">Concludi</button>
    </div>
  </div>
</div>

<!-- TRIP DETAIL MODAL -->
<div class="modal-overlay" id="modal-trip-detail">
  <div class="modal" id="trip-detail-content"></div>
</div>

<!-- CONFIRM DELETE MODAL -->
<div class="modal-overlay" id="modal-confirm-delete">
  <div class="modal">
    <h3>üóëÔ∏è Conferma</h3>
    <p style="margin-bottom:20px; color:var(--text-dim)">Eliminare definitivamente questo viaggio? Azione irreversibile.</p>
    <div class="actions-row">
        <button class="btn btn-outline" onclick="closeModal('modal-confirm-delete')">Annulla</button>
        <button class="btn btn-danger" onclick="confirmDeleteAction()">Elimina</button>
    </div>
  </div>
</div>

<script>
// ====== THEME HANDLING ======
function toggleTheme() {
  document.body.classList.toggle('light-mode');
  const isLight = document.body.classList.contains('light-mode');
  document.getElementById('theme-btn').textContent = isLight ? '‚òÄÔ∏è' : 'üåô';
  localStorage.setItem('tesla_theme', isLight ? 'light' : 'dark');
}

// Load saved theme
const savedTheme = localStorage.getItem('tesla_theme');
if (savedTheme === 'light') {
  document.body.classList.add('light-mode');
  document.getElementById('theme-btn').textContent = '‚òÄÔ∏è';
}

// ====== DATA LAYER ======
const STORAGE_KEY = 'tesla_trip_data_v4';
let tripToDeleteId = null;

function loadData() {
  try {
    const d = JSON.parse(localStorage.getItem(STORAGE_KEY));
    return d || { trips: [], activeTrip: null };
  } catch { return { trips: [], activeTrip: null }; }
}

function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}

let data = loadData();
let currentGPS = null;
let tripMapInstance = null;
let globalMapInstance = null;

// ====== GPS ======
function acquireGPS(callback) {
  const statusEl = document.getElementById('gps-status');
  if (!navigator.geolocation) {
    statusEl.innerHTML = '<div class="gps-dot error"></div> GPS non disponibile';
    callback(null);
    return;
  }
  navigator.geolocation.getCurrentPosition(
    (pos) => {
      currentGPS = { lat: pos.coords.latitude, lng: pos.coords.longitude };
      statusEl.innerHTML = `<div class="gps-dot"></div> GPS ok`;
      if (callback) callback(currentGPS);
    },
    (err) => {
      statusEl.innerHTML = '<div class="gps-dot error"></div> GPS errore';
      currentGPS = null;
      if (callback) callback(null);
    },
    { enableHighAccuracy: true, timeout: 10000 }
  );
}

// ====== NAVIGATION ======
function showSection(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`section-${name}`).classList.add('active');
  event.target.classList.add('active');
  if (name === 'active') renderActiveTrip();
  if (name === 'trips') renderTripsList();
  if (name === 'map') setTimeout(() => renderGlobalMap(), 100);
}

function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }

// ====== NEW TRIP ======
function openNewTripModal() {
  if (data.activeTrip) {
    alert('Hai gi√† un viaggio attivo! Concludilo prima di iniziarne uno nuovo.');
    return;
  }
  document.getElementById('trip-name').value = '';
  document.getElementById('trip-start-km').value = '';
  document.getElementById('trip-start-kwh').value = '';
  document.getElementById('trip-start-soc').value = '100'; 
  openModal('modal-new-trip');
}

function createTrip() {
  const name = document.getElementById('trip-name').value.trim();
  const startKm = parseFloat(document.getElementById('trip-start-km').value);
  const startKwh = parseFloat(document.getElementById('trip-start-kwh').value);
  const startSoC = parseFloat(document.getElementById('trip-start-soc').value) || 100;
  const dieselPrice = parseFloat(document.getElementById('diesel-price').value) || 1.75;
  const dieselConsumption = parseFloat(document.getElementById('diesel-consumption').value) || 15;

  if (!name || isNaN(startKm) || isNaN(startKwh)) {
    alert('Compila tutti i campi obbligatori.');
    return;
  }

  const trip = {
    id: Date.now().toString(),
    name,
    date: new Date().toISOString(),
    startKm,
    startKwh,
    startSoC,
    endKm: null,
    endKwh: null,
    endSoC: null,
    dieselPrice,
    dieselConsumption,
    charges: [],
    completed: false
  };

  data.activeTrip = trip;
  saveData(data);
  closeModal('modal-new-trip');
  showSectionDirect('active');
}

function showSectionDirect(name) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`section-${name}`).classList.add('active');
  document.querySelectorAll('.nav-tab').forEach(t => {
    if (t.textContent.toLowerCase().includes(name === 'active' ? 'corso' : name)) t.classList.add('active');
  });
  if (name === 'active') renderActiveTrip();
  if (name === 'map') setTimeout(() => renderGlobalMap(), 100);
}

// ====== EDIT TRIP ======
function openEditTripModal(id) {
  let trip = data.trips.find(t => t.id === id);
  if (!trip && data.activeTrip && data.activeTrip.id === id) {
      trip = data.activeTrip;
  }
  
  if (!trip) return;

  document.getElementById('edit-trip-id').value = trip.id;
  document.getElementById('edit-trip-name').value = trip.name;
  document.getElementById('edit-trip-start-km').value = trip.startKm;
  document.getElementById('edit-trip-start-kwh').value = trip.startKwh;
  document.getElementById('edit-trip-start-soc').value = trip.startSoC || 100;
  document.getElementById('edit-diesel-price').value = trip.dieselPrice;
  document.getElementById('edit-diesel-consumption').value = trip.dieselConsumption;

  closeModal('modal-trip-detail');
  openModal('modal-edit-trip');
}

function saveEditedTrip() {
  const id = document.getElementById('edit-trip-id').value;
  let trip = data.trips.find(t => t.id === id);
  let isActive = false;
  
  if (!trip && data.activeTrip && data.activeTrip.id === id) {
      trip = data.activeTrip;
      isActive = true;
  }

  if (trip) {
      trip.name = document.getElementById('edit-trip-name').value;
      trip.startKm = parseFloat(document.getElementById('edit-trip-start-km').value);
      trip.startKwh = parseFloat(document.getElementById('edit-trip-start-kwh').value);
      trip.startSoC = parseFloat(document.getElementById('edit-trip-start-soc').value);
      trip.dieselPrice = parseFloat(document.getElementById('edit-diesel-price').value);
      trip.dieselConsumption = parseFloat(document.getElementById('edit-diesel-consumption').value);
      
      saveData(data);
      closeModal('modal-edit-trip');
      
      if (isActive) {
          renderActiveTrip();
      } else {
          renderTripsList();
          showTripDetail(id);
      }
  }
}

// ====== CHARGE ======
function openChargeModal() {
  document.getElementById('charge-name').value = '';
  document.getElementById('charge-cost-kwh').value = '';
  document.getElementById('charge-kwh-added').value = '';
  
  const kmInput = document.getElementById('charge-km');
  const kwhInput = document.getElementById('charge-kwh-consumed');
  const socArrInput = document.getElementById('charge-soc-arr');
  const socDepInput = document.getElementById('charge-soc-dep');
  
  kmInput.value = '';
  kwhInput.value = '';
  socArrInput.value = '';
  socDepInput.value = '';

  if (data.activeTrip) {
      const trip = data.activeTrip;
      let lastKm = trip.startKm;
      let lastKwh = trip.startKwh;
      let lastSoC = trip.startSoC;
      
      if (trip.charges && trip.charges.length > 0) {
          const lastCharge = trip.charges[trip.charges.length - 1];
          lastKm = lastCharge.km;
          lastKwh = lastCharge.kwhConsumed;
          if (lastCharge.departureSoC) lastSoC = lastCharge.departureSoC;
      }
      
      kmInput.placeholder = `> ${lastKm}`;
      kwhInput.placeholder = `> ${lastKwh}`;
      socArrInput.placeholder = lastSoC ? `< ${lastSoC}` : '10';
      socDepInput.placeholder = '80';
      
      document.getElementById('last-km-hint').textContent = `Ultimo: ${lastKm}`;
      document.getElementById('last-kwh-hint').textContent = `Ultimo: ${lastKwh}`;
  }

  currentGPS = null;
  openModal('modal-charge');
  acquireGPS(null);
}

function saveCharge() {
  const name = document.getElementById('charge-name').value.trim() || 'Ricarica';
  const km = parseFloat(document.getElementById('charge-km').value);
  const kwhConsumed = parseFloat(document.getElementById('charge-kwh-consumed').value);
  const costKwh = parseFloat(document.getElementById('charge-cost-kwh').value);
  const kwhAdded = parseFloat(document.getElementById('charge-kwh-added').value);
  const arrivalSoC = parseFloat(document.getElementById('charge-soc-arr').value);
  const departureSoC = parseFloat(document.getElementById('charge-soc-dep').value);

  if (isNaN(km) || isNaN(kwhConsumed) || isNaN(costKwh) || isNaN(kwhAdded)) {
    alert('Compila tutti i campi numerici.');
    return;
  }

  const charge = {
    id: Date.now().toString(),
    name,
    km,
    kwhConsumed,
    costKwh,
    kwhAdded,
    arrivalSoC: isNaN(arrivalSoC) ? null : arrivalSoC,
    departureSoC: isNaN(departureSoC) ? null : departureSoC,
    totalCost: +(costKwh * kwhAdded).toFixed(2),
    gps: currentGPS ? { ...currentGPS } : null,
    timestamp: new Date().toISOString()
  };

  data.activeTrip.charges.push(charge);
  saveData(data);
  closeModal('modal-charge');
  renderActiveTrip();
}

// ====== EDIT CHARGE ======
function openEditChargeModal(tripId, chargeIndex) {
  let trip = data.trips.find(t => t.id === tripId);
  if (!trip && data.activeTrip && data.activeTrip.id === tripId) {
    trip = data.activeTrip;
  }
  
  if (!trip || !trip.charges[chargeIndex]) return;

  const charge = trip.charges[chargeIndex];
  
  document.getElementById('edit-charge-trip-id').value = tripId;
  document.getElementById('edit-charge-index').value = chargeIndex;
  document.getElementById('edit-charge-name').value = charge.name;
  document.getElementById('edit-charge-km').value = charge.km;
  document.getElementById('edit-charge-kwh-consumed').value = charge.kwhConsumed;
  document.getElementById('edit-charge-cost-kwh').value = charge.costKwh;
  document.getElementById('edit-charge-kwh-added').value = charge.kwhAdded;
  document.getElementById('edit-charge-soc-arr').value = charge.arrivalSoC || '';
  document.getElementById('edit-charge-soc-dep').value = charge.departureSoC || '';

  openModal('modal-edit-charge');
}

function saveEditedCharge() {
  const tripId = document.getElementById('edit-charge-trip-id').value;
  const chargeIndex = parseInt(document.getElementById('edit-charge-index').value);
  
  let trip = data.trips.find(t => t.id === tripId);
  let isActive = false;
  
  if (!trip && data.activeTrip && data.activeTrip.id === tripId) {
    trip = data.activeTrip;
    isActive = true;
  }
  
  if (trip && trip.charges[chargeIndex]) {
    const charge = trip.charges[chargeIndex];
    charge.name = document.getElementById('edit-charge-name').value;
    charge.km = parseFloat(document.getElementById('edit-charge-km').value);
    charge.kwhConsumed = parseFloat(document.getElementById('edit-charge-kwh-consumed').value);
    charge.costKwh = parseFloat(document.getElementById('edit-charge-cost-kwh').value);
    charge.kwhAdded = parseFloat(document.getElementById('edit-charge-kwh-added').value);
    const arr = parseFloat(document.getElementById('edit-charge-soc-arr').value);
    const dep = parseFloat(document.getElementById('edit-charge-soc-dep').value);
    charge.arrivalSoC = isNaN(arr) ? null : arr;
    charge.departureSoC = isNaN(dep) ? null : dep;
    
    charge.totalCost = +(charge.costKwh * charge.kwhAdded).toFixed(2);
    
    saveData(data);
    closeModal('modal-edit-charge');
    
    if (isActive) {
      renderActiveTrip();
    } else {
      if (document.getElementById('modal-trip-detail').classList.contains('show')) {
         showTripDetail(tripId);
      }
    }
  }
}

function deleteCharge() {
  if (!confirm('Eliminare questa ricarica?')) return;
  const tripId = document.getElementById('edit-charge-trip-id').value;
  const chargeIndex = parseInt(document.getElementById('edit-charge-index').value);
  let trip = data.trips.find(t => t.id === tripId);
  let isActive = false;
  if (!trip && data.activeTrip && data.activeTrip.id === tripId) {
    trip = data.activeTrip;
    isActive = true;
  }
  if (trip) {
    trip.charges.splice(chargeIndex, 1);
    saveData(data);
    closeModal('modal-edit-charge');
    if (isActive) renderActiveTrip();
    else if (document.getElementById('modal-trip-detail').classList.contains('show')) showTripDetail(tripId);
  }
}

// ====== END TRIP ======
function openEndTripModal() {
  document.getElementById('end-km').value = '';
  document.getElementById('end-kwh').value = '';
  document.getElementById('end-soc').value = '';
  openModal('modal-end-trip');
}

function endTrip() {
  const endKm = parseFloat(document.getElementById('end-km').value);
  const endKwh = parseFloat(document.getElementById('end-kwh').value);
  const endSoC = parseFloat(document.getElementById('end-soc').value);

  if (isNaN(endKm) || isNaN(endKwh)) {
    alert('Inserisci i dati finali.');
    return;
  }

  data.activeTrip.endKm = endKm;
  data.activeTrip.endKwh = endKwh;
  data.activeTrip.endSoC = isNaN(endSoC) ? null : endSoC;
  data.activeTrip.completed = true;
  data.activeTrip.endDate = new Date().toISOString();
  data.trips.unshift(data.activeTrip);
  data.activeTrip = null;
  saveData(data);
  closeModal('modal-end-trip');
  showSectionDirect('trips');
}

// ====== RENDER ACTIVE TRIP ======
function renderActiveTrip() {
  if (!data.activeTrip) {
    document.getElementById('no-active-trip').style.display = '';
    document.getElementById('active-trip-content').style.display = 'none';
    return;
  }
  document.getElementById('no-active-trip').style.display = 'none';
  document.getElementById('active-trip-content').style.display = '';

  const trip = data.activeTrip;
  
  document.getElementById('active-trip-name').innerHTML = `${trip.name} <span style="font-size:16px; cursor:pointer; margin-left:8px" onclick="openEditTripModal('${trip.id}')">‚úèÔ∏è</span>`;

  const lastKm = trip.charges.length ? trip.charges[trip.charges.length - 1].km : trip.startKm;
  const lastKwh = trip.charges.length ? trip.charges[trip.charges.length - 1].kwhConsumed : trip.startKwh;
  const kmDriven = lastKm - trip.startKm;
  const kwhUsed = lastKwh - trip.startKwh;
  const efficiency = kmDriven > 0 ? ((kwhUsed * 1000) / kmDriven).toFixed(0) : 0;
  const totalCost = trip.charges.reduce((s, c) => s + c.totalCost, 0);
  const totalKwhCharged = trip.charges.reduce((s, c) => s + c.kwhAdded, 0);

  document.getElementById('stat-km').textContent = kmDriven.toLocaleString('it');
  document.getElementById('stat-kwh').textContent = kwhUsed.toFixed(1);
  document.getElementById('stat-efficiency').textContent = efficiency;
  document.getElementById('stat-cost').textContent = `‚Ç¨${totalCost.toFixed(2)}`;
  document.getElementById('stat-charges').textContent = trip.charges.length;
  document.getElementById('stat-kwh-charged').textContent = totalKwhCharged.toFixed(1);

  renderDieselComparison(trip, kmDriven, totalCost);
  renderChargeLog(trip);
  renderTripMap(trip);
}

function renderDieselComparison(trip, kmDriven, teslaCost) {
  const container = document.getElementById('diesel-comparison-content');
  if (kmDriven <= 0) {
    container.innerHTML = '<p style="font-size:13px;color:var(--text-dim);">Dati insufficienti.</p>';
    return;
  }

  const dieselLiters = kmDriven / trip.dieselConsumption;
  const dieselCost = dieselLiters * trip.dieselPrice;
  const maxCost = Math.max(dieselCost, teslaCost, 1);
  const teslaPercent = Math.max(5, (teslaCost / maxCost) * 100);
  const dieselPercent = Math.max(5, (dieselCost / maxCost) * 100);

  container.innerHTML = `
    <div class="comparison-bar">
      <div class="bar-label"><span>Tesla</span><span>‚Ç¨${teslaCost.toFixed(2)}</span></div>
      <div class="bar-container">
        <div class="bar-fill" style="width:${teslaPercent}%;background:linear-gradient(90deg,var(--tesla-blue),#5ea3ff);">‚Ç¨${teslaCost.toFixed(2)}</div>
      </div>
      <div class="bar-label"><span>Diesel</span><span>‚Ç¨${dieselCost.toFixed(2)}</span></div>
      <div class="bar-container">
        <div class="bar-fill" style="width:${dieselPercent}%;background:linear-gradient(90deg,var(--amber),#e8a800);">‚Ç¨${dieselCost.toFixed(2)}</div>
      </div>
    </div>
  `;
}

function renderChargeLog(trip) {
  const container = document.getElementById('charge-log');
  if (!trip.charges.length) {
    container.innerHTML = '<p style="font-size:13px;color:var(--text-dim);">Nessuna ricarica.</p>';
    return;
  }

  container.innerHTML = trip.charges.map((c, i) => {
    const segKm = i === 0 ? (c.km - trip.startKm) : (c.km - trip.charges[i - 1].km);
    const segKwh = i === 0 ? (c.kwhConsumed - trip.startKwh) : (c.kwhConsumed - trip.charges[i - 1].kwhConsumed);
    const segEff = segKm > 0 ? ((segKwh * 1000) / segKm).toFixed(0) : '‚Äî';
    const time = new Date(c.timestamp).toLocaleString('it-IT', { day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit' });
    let socHtml = '';
    if (c.arrivalSoC !== null && c.departureSoC !== null) {
      socHtml = `<div class="soc-badge">${c.arrivalSoC}% ‚ûî ${c.departureSoC}%</div>`;
    }
    return `
      <div class="charge-entry">
        <div class="charge-entry-header">
          <span class="charge-entry-name">‚ö° ${c.name}</span>
          <div style="display:flex;align-items:center;gap:6px">
             <span class="charge-entry-num">#${i + 1}</span>
             <button class="btn btn-outline btn-xs" onclick="openEditChargeModal('${trip.id}', ${i})">‚úèÔ∏è</button>
          </div>
        </div>
        <div class="charge-entry-details">
          <div><div class="charge-detail-label">Tratta</div><div class="charge-detail-value">${segKm} km</div></div>
          <div><div class="charge-detail-label">Consumo</div><div class="charge-detail-value">${segKwh.toFixed(1)} kWh</div></div>
          <div><div class="charge-detail-label">Eff.</div><div class="charge-detail-value">${segEff} Wh</div></div>
          <div><div class="charge-detail-label">Caricati</div><div class="charge-detail-value">${c.kwhAdded} kWh</div></div>
          <div><div class="charge-detail-label">‚Ç¨/kWh</div><div class="charge-detail-value">‚Ç¨${c.costKwh}</div></div>
          <div><div class="charge-detail-label">Totale</div><div class="charge-detail-value" style="color:var(--amber)">‚Ç¨${c.totalCost.toFixed(2)}</div></div>
        </div>
        ${socHtml}
      </div>
    `;
  }).join('');
}

// ====== MAPS ======
function renderTripMap(trip) {
  const container = document.getElementById('trip-map');
  const chargesWithGPS = trip.charges.filter(c => c.gps);

  if (tripMapInstance) { tripMapInstance.remove(); tripMapInstance = null; }

  if (!chargesWithGPS.length) {
    container.innerHTML = '<div class="empty-state" style="padding:20px"><p style="font-size:12px">No GPS</p></div>';
    container.style.height = '80px';
    return;
  }

  container.style.height = '250px';
  container.innerHTML = '';
  tripMapInstance = L.map(container, { zoomControl: false }).setView([chargesWithGPS[0].gps.lat, chargesWithGPS[0].gps.lng], 7);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '', maxZoom: 19
   }).addTo(tripMapInstance);

  const markers = [];
  chargesWithGPS.forEach((c, i) => {
    L.circleMarker([c.gps.lat, c.gps.lng], {
      radius: 8, fillColor: '#3e8bff', color: '#fff', weight: 2, fillOpacity: 0.9
    }).addTo(tripMapInstance);
    markers.push([c.gps.lat, c.gps.lng]);
  });

  if (markers.length > 1) {
    L.polyline(markers, { color: '#3e8bff', weight: 3, opacity: 0.6 }).addTo(tripMapInstance);
    tripMapInstance.fitBounds(markers, { padding: [40, 40] });
  }
}

function renderGlobalMap() {
  const container = document.getElementById('map');
  if (globalMapInstance) { globalMapInstance.remove(); globalMapInstance = null; }

  const allCharges = [];
  if (data.activeTrip) data.activeTrip.charges.forEach(c => { if (c.gps) allCharges.push({ ...c, tripName: data.activeTrip.name }); });
  data.trips.forEach(t => { t.charges.forEach(c => { if (c.gps) allCharges.push({ ...c, tripName: t.name }); }); });

  if (!allCharges.length) {
    container.innerHTML = '<div class="empty-state" style="padding:30px"><div class="icon">üìç</div><p>No GPS</p></div>';
    container.style.height = '200px';
    return;
  }

  container.style.height = '320px';
  container.innerHTML = '';
  globalMapInstance = L.map(container, { zoomControl: false }).setView([allCharges[0].gps.lat, allCharges[0].gps.lng], 6);
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '', maxZoom: 19 }).addTo(globalMapInstance);

  const bounds = [];
  allCharges.forEach(c => {
    L.circleMarker([c.gps.lat, c.gps.lng], {
      radius: 6, fillColor: '#e74040', color: '#fff', weight: 2, fillOpacity: 0.9
    }).addTo(globalMapInstance);
    bounds.push([c.gps.lat, c.gps.lng]);
  });

  if (bounds.length > 1) globalMapInstance.fitBounds(bounds, { padding: [40, 40] });
}

// ====== TRIPS LIST ======
function renderTripsList() {
  const container = document.getElementById('trips-list');

  if (!data.trips.length && !data.activeTrip) {
    container.innerHTML = '<div class="empty-state"><div class="icon">üó∫Ô∏è</div><p>Nessun viaggio ancora.</p></div>';
    return;
  }

  let html = '';

  if (data.activeTrip) {
    const t = data.activeTrip;
    const lastKm = t.charges.length ? t.charges[t.charges.length - 1].km : t.startKm;
    const kmDriven = lastKm - t.startKm;
    html += `
      <div class="trip-item" onclick="showSectionDirect('active')" style="border-left:4px solid var(--green)">
        <div class="trip-item-header">
          <span class="trip-item-name">üü¢ ${t.name}</span>
        </div>
        <div class="trip-item-stats">
          <div><span>${kmDriven}</span> km</div>
          <div><span>${t.charges.length}</span> ricariche</div>
        </div>
      </div>
    `;
  }

  data.trips.forEach(t => {
    const kmDriven = (t.endKm || t.startKm) - t.startKm;
    const totalCost = t.charges.reduce((s, c) => s + c.totalCost, 0);
    const date = new Date(t.date).toLocaleDateString('it-IT');
    html += `
      <div class="trip-item" onclick="showTripDetail('${t.id}')">
        <div class="trip-item-header">
          <span class="trip-item-name">${t.name}</span>
          <span class="trip-item-date">${date}</span>
        </div>
        <div class="trip-item-stats">
          <div><span>${kmDriven.toLocaleString('it')}</span> km</div>
          <div><span>${t.charges.length}</span> ricariche</div>
          <div><span>‚Ç¨${totalCost.toFixed(2)}</span></div>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
}

// ====== TRIP DETAIL ======
function showTripDetail(id) {
  const trip = data.trips.find(t => t.id === id);
  if (!trip) return;

  const kmDriven = (trip.endKm || trip.startKm) - trip.startKm;
  const kwhUsed = (trip.endKwh || trip.startKwh) - trip.startKwh;
  const efficiency = kmDriven > 0 ? ((kwhUsed * 1000) / kmDriven).toFixed(0) : '‚Äî';
  const totalCost = trip.charges.reduce((s, c) => s + c.totalCost, 0);
  const totalKwhCharged = trip.charges.reduce((s, c) => s + c.kwhAdded, 0);
  const dieselLiters = kmDriven / trip.dieselConsumption;
  const dieselCost = dieselLiters * trip.dieselPrice;
  const saving = dieselCost - totalCost;
  const dateStart = new Date(trip.date).toLocaleDateString('it-IT');
  const dateEnd = trip.endDate ? new Date(trip.endDate).toLocaleDateString('it-IT') : '‚Äî';

  let socInfo = '';
  if (trip.startSoC !== undefined && trip.endSoC !== undefined && trip.endSoC !== null) {
      socInfo = `<div style="text-align:center; margin-bottom:12px; font-size:13px; color:var(--text-dim); font-weight:600">Batteria: ${trip.startSoC}% ‚ûî ${trip.endSoC}%</div>`;
  }

  const content = document.getElementById('trip-detail-content');
  content.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
      <h3 style="margin:0">${trip.name}</h3>
      <button class="btn btn-outline btn-xs" onclick="closeModal('modal-trip-detail')" style="width:40px;height:40px;font-size:18px">‚úï</button>
    </div>
    <div style="display:flex; gap:10px; margin-bottom:16px">
        <button class="btn btn-blue btn-sm" onclick="openEditTripModal('${trip.id}')" style="flex:1">‚úèÔ∏è Modifica</button>
    </div>
    <p style="text-align:center; font-size:13px;color:var(--text-dim);margin-bottom:8px">${dateStart} ‚Üí ${dateEnd}</p>
    ${socInfo}
    <div class="stats-grid">
      <div class="stat-box"><div class="stat-value blue">${kmDriven.toLocaleString('it')}</div><div class="stat-label">km</div></div>
      <div class="stat-box"><div class="stat-value amber">${kwhUsed.toFixed(1)}</div><div class="stat-label">kWh</div></div>
      <div class="stat-box"><div class="stat-value green">${efficiency}</div><div class="stat-label">Wh/km</div></div>
      <div class="stat-box"><div class="stat-value red">‚Ç¨${totalCost.toFixed(2)}</div><div class="stat-label">Totale</div></div>
    </div>
    <div class="divider"></div>
    <div class="card-title"><span class="dot" style="background:var(--amber)"></span> Risparmio Diesel</div>
    <div style="text-align:center; margin:16px 0">
      <div style="font-family:'JetBrains Mono';font-size:28px;font-weight:700;color:${saving >= 0 ? 'var(--green)' : 'var(--accent)'}">
        ${saving >= 0 ? '+' : '-'}‚Ç¨${Math.abs(saving).toFixed(2)}
      </div>
      <div style="font-size:12px;color:var(--text-dim);margin-top:4px">rispetto a ${dieselCost.toFixed(2)}‚Ç¨ di gasolio</div>
    </div>
    <div class="divider"></div>
    <div class="card-title"><span class="dot" style="background:var(--tesla-blue)"></span> Ricariche</div>
    ${trip.charges.map((c, i) => {
      const segKm = i === 0 ? (c.km - trip.startKm) : (c.km - trip.charges[i - 1].km);
      let socHtml = '';
      if (c.arrivalSoC !== null && c.departureSoC !== null) {
        socHtml = `<div class="soc-badge" style="margin-top:6px">${c.arrivalSoC}% ‚ûî ${c.departureSoC}%</div>`;
      }
      return `<div class="charge-entry">
        <div class="charge-entry-header">
           <span class="charge-entry-name">‚ö° ${c.name}</span>
           <div style="display:flex;align-items:center;gap:8px">
             <span class="charge-entry-num">#${i+1}</span>
             <button class="btn btn-outline btn-xs" onclick="openEditChargeModal('${trip.id}', ${i})">‚úèÔ∏è</button>
           </div>
        </div>
        <div class="charge-entry-details" style="grid-template-columns:1fr 1fr 1fr">
          <div><div class="charge-detail-label">Tratta</div><div class="charge-detail-value">${segKm} km</div></div>
          <div><div class="charge-detail-label">Caricati</div><div class="charge-detail-value">${c.kwhAdded} kWh</div></div>
          <div><div class="charge-detail-label">Costo</div><div class="charge-detail-value" style="color:var(--amber)">‚Ç¨${c.totalCost.toFixed(2)}</div></div>
        </div>
        ${socHtml}
      </div>`;
    }).join('')}
    <div style="margin-top:24px">
      <button class="btn btn-danger" onclick="triggerDeleteTrip('${trip.id}')">üóëÔ∏è Elimina Viaggio</button>
    </div>
  `;

  openModal('modal-trip-detail');
}

function triggerDeleteTrip(id) {
    tripToDeleteId = id;
    openModal('modal-confirm-delete');
}

function confirmDeleteAction() {
    if (!tripToDeleteId) return;
    
    data.trips = data.trips.filter(t => t.id !== tripToDeleteId);
    saveData(data);
    
    closeModal('modal-confirm-delete');
    closeModal('modal-trip-detail');
    renderTripsList();
    tripToDeleteId = null;
}

// ====== INIT ======
renderTripsList();
if (data.activeTrip) renderActiveTrip();
</script>

</body>
</html>
